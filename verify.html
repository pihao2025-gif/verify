<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>äººæœºéªŒè¯</title>
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        /* iOS/Android è§¦æ‘¸å…¼å®¹æ€§ */
        html, body {
            overscroll-behavior: none;
            -webkit-overflow-scrolling: touch;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            /* é˜²æ­¢ iOS Safari æ©¡çš®ç­‹æ•ˆæœ */
            position: fixed;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 24px;
            padding: 30px 25px;
            max-width: 380px;
            width: 100%;
            text-align: center;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
        }
        
        .step-indicator {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 25px;
        }
        
        .step-dot {
            width: 50px;
            height: 6px;
            border-radius: 3px;
            background: #e0e0e0;
            transition: all 0.3s;
        }
        
        .step-dot.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            width: 80px;
        }
        
        .step-dot.completed { background: #4CAF50; }
        
        .icon { font-size: 48px; margin-bottom: 12px; }
        
        h1 {
            color: #333;
            font-size: 20px;
            margin-bottom: 6px;
            font-weight: 600;
        }
        
        .subtitle {
            color: #888;
            font-size: 13px;
            margin-bottom: 20px;
        }
        
        .step { display: none; }
        .step.active {
            display: block;
            animation: fadeIn 0.4s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .turnstile-wrapper {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            min-height: 65px;
        }
        
        /* æ‹¼å›¾éªŒè¯ */
        .puzzle-wrapper {
            position: relative;
            width: 300px;
            height: 180px;
            margin: 15px auto;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .puzzle-canvas { width: 100%; height: 100%; display: block; }
        
        .puzzle-piece-canvas {
            position: absolute;
            top: 0;
            left: 10px;
            pointer-events: none;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5));
        }
        
        .slider-container {
            width: 300px;
            margin: 15px auto;
            position: relative;
            touch-action: none;
        }
        
        .slider-track {
            width: 100%;
            height: 50px;
            background: linear-gradient(to right, #f0f0f0, #e8e8e8);
            border-radius: 25px;
            position: relative;
            overflow: hidden;
            border: 2px solid #ddd;
            touch-action: none;
        }
        
        .slider-progress {
            position: absolute;
            left: 0; top: 0;
            height: 100%;
            width: 0;
            background: linear-gradient(to right, rgba(102, 126, 234, 0.3), rgba(118, 75, 162, 0.3));
            border-radius: 25px;
        }
        
        .slider-text {
            position: absolute;
            width: 100%;
            text-align: center;
            line-height: 50px;
            color: #999;
            font-size: 13px;
            user-select: none;
            pointer-events: none;
        }
        
        .slider-thumb {
            position: absolute;
            width: 54px;
            height: 46px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 23px;
            top: 2px;
            left: 2px;
            cursor: grab;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 22px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: transform 0.1s, box-shadow 0.2s;
            z-index: 10;
            touch-action: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
        }
        
        .slider-thumb:hover {
            transform: scale(1.02);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }
        
        .slider-thumb:active { cursor: grabbing; transform: scale(0.98); }
        .slider-thumb.success { background: linear-gradient(135deg, #4CAF50, #45a049); }
        .slider-thumb.error {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            animation: shake 0.5s;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-8px); }
            40%, 80% { transform: translateX(8px); }
        }
        
        .attempt-info {
            font-size: 12px;
            color: #e74c3c;
            margin-top: 10px;
            font-weight: 500;
        }
        
        .refresh-btn {
            background: none;
            border: none;
            color: #667eea;
            cursor: pointer;
            font-size: 13px;
            margin-top: 10px;
            padding: 5px 15px;
            border-radius: 15px;
            transition: background 0.2s;
        }
        
        .refresh-btn:hover { background: rgba(102, 126, 234, 0.1); }
        
        .status {
            padding: 12px 20px;
            border-radius: 12px;
            margin-top: 15px;
            font-size: 14px;
            display: none;
        }
        
        .status.success { background: #d4edda; color: #155724; display: block; }
        .status.error { background: #f8d7da; color: #721c24; display: block; }
        .status.loading { background: #fff3cd; color: #856404; display: block; }
        
        .loading-spinner {
            display: inline-block;
            width: 14px; height: 14px;
            border: 2px solid currentColor;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .footer { margin-top: 20px; color: #bbb; font-size: 11px; }
        
        .success-animation {
            display: none;
            flex-direction: column;
            align-items: center;
            animation: successPop 0.5s ease;
        }
        
        .success-animation.show { display: flex; }
        
        @keyframes successPop {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .success-icon { font-size: 72px; margin-bottom: 15px; }
        .success-text { font-size: 22px; font-weight: bold; color: #4CAF50; }
    </style>
</head>
<body>
    <div class="container">
        <div class="step-indicator">
            <div class="step-dot active" id="dot1"></div>
            <div class="step-dot" id="dot2"></div>
        </div>
        
        <!-- ç¬¬ä¸€æ­¥ï¼šTurnstile -->
        <div class="step active" id="step1">
            <div class="icon">ğŸ›¡ï¸</div>
            <h1>å®‰å…¨ç¯å¢ƒæ£€æµ‹</h1>
            <p class="subtitle">æ­£åœ¨æ£€æµ‹æ‚¨çš„æµè§ˆå™¨ç¯å¢ƒ...</p>
            <div class="turnstile-wrapper">
                <div class="cf-turnstile" 
                     data-sitekey="0x4AAAAAACH4j7seS-GltmvM"
                     data-callback="onTurnstileSuccess"
                     data-error-callback="onTurnstileError"
                     data-theme="light">
                </div>
            </div>
            <div id="status1" class="status"></div>
        </div>
        
        <!-- ç¬¬äºŒæ­¥ï¼šå›¾ç‰‡æ‹¼å›¾ -->
        <div class="step" id="step2">
            <div class="icon">ğŸ§©</div>
            <h1>æ»‘åŠ¨å®Œæˆæ‹¼å›¾</h1>
            <p class="subtitle">æ‹–åŠ¨æ»‘å—ï¼Œä½¿æ‹¼å›¾å—å¯¹å‡†ç¼ºå£</p>
            
            <div class="puzzle-wrapper">
                <canvas class="puzzle-canvas" id="puzzleCanvas" width="300" height="180"></canvas>
                <canvas class="puzzle-piece-canvas" id="pieceCanvas"></canvas>
            </div>
            
            <div class="slider-container">
                <div class="slider-track" id="sliderTrack">
                    <div class="slider-progress" id="sliderProgress"></div>
                    <span class="slider-text">âœ æ‹–åŠ¨æ»‘å—å®Œæˆæ‹¼å›¾</span>
                    <div class="slider-thumb" id="sliderThumb">â¬Œ</div>
                </div>
            </div>
            
            <p class="attempt-info" id="attemptInfo"></p>
            <button class="refresh-btn" id="refreshBtn">ğŸ”„ æ¢ä¸€å¼ å›¾ç‰‡</button>
            
            <div id="status2" class="status"></div>
        </div>
        
        <!-- æˆåŠŸé¡µé¢ -->
        <div class="success-animation" id="successPage">
            <div class="success-icon">âœ…</div>
            <div class="success-text">éªŒè¯æˆåŠŸï¼</div>
            <p class="subtitle" style="margin-top: 15px; color: #666;">æ­£åœ¨è¿”å›æœºå™¨äºº...</p>
        </div>
        
        <p class="footer">åŒé‡éªŒè¯ä¿æŠ¤ Â· é˜²æ­¢æ¶æ„æœºå™¨äºº</p>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
        
        const user = tg.initDataUnsafe?.user;
        const userId = user?.id;
        
        let turnstileToken = null;
        let puzzleAttempts = 0;
        const maxAttempts = 5;
        
        // è½¨è¿¹æ•°æ®
        let trajectory = [];
        let startTime = 0;
        
        // æ­¥éª¤ç®¡ç†
        function goToStep(step) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById('step' + step).classList.add('active');
            
            document.getElementById('dot1').classList.remove('active', 'completed');
            document.getElementById('dot2').classList.remove('active', 'completed');
            
            if (step === 1) {
                document.getElementById('dot1').classList.add('active');
            } else {
                document.getElementById('dot1').classList.add('completed');
                document.getElementById('dot2').classList.add('active');
            }
        }
        
        function showStatus(step, type, message) {
            const status = document.getElementById('status' + step);
            status.className = 'status ' + type;
            status.innerHTML = message;
        }
        
        // ç¬¬ä¸€æ­¥ï¼šTurnstileï¼ˆè‡ªåŠ¨è·³è¿‡ï¼Œç›´æ¥è¿›å…¥æ‹¼å›¾ï¼‰
        function onTurnstileSuccess(token) {
            turnstileToken = token;
            showStatus(1, 'success', 'âœ… ç¯å¢ƒæ£€æµ‹é€šè¿‡');
            setTimeout(() => { goToStep(2); initPuzzle(); }, 800);
        }
        
        function onTurnstileError() {
            // Turnstile å¤±è´¥æ—¶è‡ªåŠ¨è·³è¿‡ï¼Œç›´æ¥è¿›å…¥æ‹¼å›¾éªŒè¯
            console.log('Turnstile skipped, going to puzzle');
            setTimeout(() => { goToStep(2); initPuzzle(); }, 500);
        }
        
        // 3ç§’åè‡ªåŠ¨è·³è¿‡ Turnstileï¼ˆå¦‚æœæ²¡æœ‰åŠ è½½æˆåŠŸï¼‰
        setTimeout(() => {
            if (document.getElementById('step1').classList.contains('active')) {
                console.log('Turnstile timeout, skipping...');
                goToStep(2);
                initPuzzle();
            }
        }, 3000);
        
        // ç¬¬äºŒæ­¥ï¼šå›¾ç‰‡æ‹¼å›¾ - ä½¿ç”¨æœ¬åœ°ç”Ÿæˆçš„æ¸å˜èƒŒæ™¯ï¼ˆç§’åŠ è½½ï¼‰
        const colorSchemes = [
            ['#667eea', '#764ba2', '#f093fb'],  // ç´«è‰²æ¸å˜
            ['#11998e', '#38ef7d', '#00b4db'],  // é’ç»¿æ¸å˜
            ['#ff6b6b', '#feca57', '#ff9ff3'],  // æš–è‰²æ¸å˜
            ['#4facfe', '#00f2fe', '#43e97b'],  // è“ç»¿æ¸å˜
            ['#fa709a', '#fee140', '#f8b500'],  // ç²‰é‡‘æ¸å˜
            ['#a18cd1', '#fbc2eb', '#a6c1ee'],  // æŸ”å’Œç´«ç²‰
            ['#30cfd0', '#330867', '#667db6'],  // æ·±è“é’
            ['#f5576c', '#f093fb', '#f5af19']   // çº¢ç´«é‡‘
        ];
        
        let slotX = 0, slotY = 0;
        const pieceSize = 50;
        const tolerance = 6;
        
        function initPuzzle() {
            puzzleAttempts = 0;
            updateAttemptInfo();
            loadNewImage();
            initSlider();
        }
        
        function loadNewImage() {
            const canvas = document.getElementById('puzzleCanvas');
            const ctx = canvas.getContext('2d');
            const pieceCanvas = document.getElementById('pieceCanvas');
            const pieceCtx = pieceCanvas.getContext('2d');
            
            // éšæœºé€‰æ‹©é…è‰²æ–¹æ¡ˆ
            const colors = colorSchemes[Math.floor(Math.random() * colorSchemes.length)];
            
            // åˆ›å»ºæ¸å˜èƒŒæ™¯
            const gradient = ctx.createLinearGradient(0, 0, 300, 180);
            gradient.addColorStop(0, colors[0]);
            gradient.addColorStop(0.5, colors[1]);
            gradient.addColorStop(1, colors[2]);
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 300, 180);
            
            // æ·»åŠ è£…é¥°æ€§å…ƒç´ 
            ctx.fillStyle = 'rgba(255,255,255,0.1)';
            for (let i = 0; i < 8; i++) {
                ctx.beginPath();
                ctx.arc(
                    Math.random() * 300, 
                    Math.random() * 180, 
                    Math.random() * 40 + 15, 
                    0, Math.PI * 2
                );
                ctx.fill();
            }
            
            // æ·»åŠ çº¿æ¡è£…é¥°
            ctx.strokeStyle = 'rgba(255,255,255,0.15)';
            ctx.lineWidth = 2;
            for (let i = 0; i < 5; i++) {
                ctx.beginPath();
                ctx.moveTo(Math.random() * 100, Math.random() * 180);
                ctx.bezierCurveTo(
                    Math.random() * 300, Math.random() * 180,
                    Math.random() * 300, Math.random() * 180,
                    200 + Math.random() * 100, Math.random() * 180
                );
                ctx.stroke();
            }
            
            // éšæœºä½ç½®
            slotX = Math.floor(Math.random() * 100) + 150;
            slotY = Math.floor(Math.random() * 60) + 60;
            
            // ç»˜åˆ¶ç¼ºå£ï¼ˆå¸¦é˜´å½±æ•ˆæœï¼‰
            ctx.save();
            drawPuzzleShape(ctx, slotX, slotY, pieceSize);
            ctx.clip();
            ctx.fillStyle = 'rgba(0, 0, 0, 0.4)';
            ctx.fillRect(slotX - 10, slotY - 10, pieceSize + 20, pieceSize + 20);
            ctx.restore();
            
            // ç¼ºå£è¾¹æ¡†
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.8)';
            ctx.lineWidth = 2;
            drawPuzzleShape(ctx, slotX, slotY, pieceSize);
            ctx.stroke();
            
            // åˆ›å»ºæ‹¼å›¾å—
            pieceCanvas.width = pieceSize + 20;
            pieceCanvas.height = pieceSize + 20;
            pieceCanvas.style.top = (slotY - 10) + 'px';
            pieceCanvas.style.left = '10px';
            
            // æ‹¼å›¾å—æ¸å˜
            const pg = pieceCtx.createLinearGradient(0, 0, pieceSize + 20, pieceSize + 20);
            pg.addColorStop(0, colors[0]);
            pg.addColorStop(0.5, colors[1]);
            pg.addColorStop(1, colors[2]);
            
            pieceCtx.save();
            drawPuzzleShape(pieceCtx, 10, 10, pieceSize);
            pieceCtx.clip();
            pieceCtx.fillStyle = pg;
            pieceCtx.fillRect(0, 0, pieceSize + 20, pieceSize + 20);
            
            // æ‹¼å›¾å—è£…é¥°
            pieceCtx.fillStyle = 'rgba(255,255,255,0.15)';
            pieceCtx.beginPath();
            pieceCtx.arc(35, 35, 20, 0, Math.PI * 2);
            pieceCtx.fill();
            pieceCtx.restore();
            
            // æ‹¼å›¾å—è¾¹æ¡†
            pieceCtx.strokeStyle = '#fff';
            pieceCtx.lineWidth = 3;
            drawPuzzleShape(pieceCtx, 10, 10, pieceSize);
            pieceCtx.stroke();
            
            resetSlider();
        }
        
        function drawPuzzleShape(ctx, x, y, size) {
            const r = size / 5;
            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.lineTo(x + size * 0.35, y);
            ctx.arc(x + size * 0.5, y, r, Math.PI, 0, true);
            ctx.lineTo(x + size, y);
            ctx.lineTo(x + size, y + size * 0.35);
            ctx.arc(x + size, y + size * 0.5, r, -Math.PI/2, Math.PI/2, false);
            ctx.lineTo(x + size, y + size);
            ctx.lineTo(x, y + size);
            ctx.lineTo(x, y);
            ctx.closePath();
        }
        
        let isDragging = false;
        let dragStartX = 0;
        let thumbStartLeft = 0;
        
        function initSlider() {
            const thumb = document.getElementById('sliderThumb');
            const track = document.getElementById('sliderTrack');
            
            // æ»‘å—äº‹ä»¶
            thumb.addEventListener('mousedown', startDrag);
            thumb.addEventListener('touchstart', startDrag, { passive: false });
            
            // è½¨é“ä¹Ÿå¯ä»¥è§¦å‘æ‹–åŠ¨ï¼ˆæå‡ä½“éªŒï¼‰
            track.addEventListener('mousedown', startDrag);
            track.addEventListener('touchstart', startDrag, { passive: false });
            
            document.addEventListener('mousemove', onDrag);
            document.addEventListener('touchmove', onDrag, { passive: false });
            document.addEventListener('mouseup', endDrag);
            document.addEventListener('touchend', endDrag);
            document.addEventListener('touchcancel', endDrag); // iOS å¯èƒ½è§¦å‘ touchcancel
            
            document.getElementById('refreshBtn').onclick = () => {
                loadNewImage();
            };
            
            // é˜²æ­¢ iOS é¡µé¢æ»šåŠ¨å¹²æ‰°æ»‘åŠ¨
            document.querySelector('.slider-container').addEventListener('touchmove', (e) => {
                if (isDragging) e.preventDefault();
            }, { passive: false });
        }
        
        function startDrag(e) {
            e.preventDefault();
            isDragging = true;
            dragStartX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
            thumbStartLeft = parseInt(document.getElementById('sliderThumb').style.left) || 2;
            
            trajectory = [];
            startTime = Date.now();
            recordPoint(e);
            
            document.getElementById('sliderThumb').classList.remove('error', 'success');
            document.getElementById('status2').className = 'status';
        }
        
        function onDrag(e) {
            if (!isDragging) return;
            e.preventDefault();
            
            const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
            const deltaX = clientX - dragStartX;
            let newLeft = Math.max(2, Math.min(thumbStartLeft + deltaX, 244));
            
            document.getElementById('sliderThumb').style.left = newLeft + 'px';
            document.getElementById('pieceCanvas').style.left = (10 + newLeft) + 'px';
            document.getElementById('sliderProgress').style.width = (newLeft + 27) + 'px';
            
            recordPoint(e);
        }
        
        function recordPoint(e) {
            const x = e.type.includes('touch') ? 
                (e.touches ? e.touches[0].clientX : e.changedTouches[0].clientX) : e.clientX;
            trajectory.push({ x, t: Date.now() - startTime });
        }
        
        function endDrag(e) {
            if (!isDragging) return;
            isDragging = false;
            recordPoint(e);
            
            const currentLeft = parseInt(document.getElementById('sliderThumb').style.left) || 2;
            const pieceX = 10 + currentLeft;
            
            // æ£€æŸ¥ä½ç½®
            if (Math.abs(pieceX - slotX + 10) <= tolerance) {
                // æ£€æŸ¥è½¨è¿¹
                if (isHumanTrajectory()) {
                    onSuccess();
                } else {
                    onFail('æ“ä½œå¼‚å¸¸ï¼Œè¯·é‡è¯•');
                }
            } else {
                onFail('ä½ç½®ä¸æ­£ç¡®');
            }
        }
        
        function isHumanTrajectory() {
            // ç§»åŠ¨ç«¯æ”¾å®½æ¡ä»¶ï¼šé‡‡æ ·ç‚¹å¯èƒ½è¾ƒå°‘
            if (trajectory.length < 3) {
                console.log('è½¨è¿¹å¤±è´¥: ç‚¹æ•°å¤ªå°‘', trajectory.length);
                return false;
            }
            
            const totalTime = trajectory[trajectory.length - 1].t;
            if (totalTime < 100) {
                console.log('è½¨è¿¹å¤±è´¥: å¤ªå¿«', totalTime + 'ms');
                return false; // 100ms æœ€ä½é™åˆ¶
            }
            if (totalTime > 30000) {
                console.log('è½¨è¿¹å¤±è´¥: å¤ªæ…¢', totalTime + 'ms');
                return false;
            }
            
            // ç§»åŠ¨ç«¯é‡‡æ ·å°‘ï¼Œåªéœ€è¦æœ‰ä¸€å®šè·ç¦»ç§»åŠ¨å³å¯
            const startX = trajectory[0].x;
            const endX = trajectory[trajectory.length - 1].x;
            const distance = Math.abs(endX - startX);
            
            console.log('è½¨è¿¹éªŒè¯: ç‚¹æ•°=' + trajectory.length + ', æ—¶é—´=' + totalTime + 'ms, è·ç¦»=' + distance);
            
            // åªè¦æœ‰æ˜æ˜¾æ»‘åŠ¨å°±é€šè¿‡
            return distance > 30;
        }
        
        function onSuccess() {
            const thumb = document.getElementById('sliderThumb');
            thumb.classList.add('success');
            thumb.innerHTML = 'âœ“';
            
            showStatus(2, 'loading', '<span class="loading-spinner"></span>éªŒè¯ä¸­...');
            
            setTimeout(completeVerification, 1000);
        }
        
        function onFail(reason) {
            puzzleAttempts++;
            updateAttemptInfo();
            
            document.getElementById('sliderThumb').classList.add('error');
            
            if (puzzleAttempts >= maxAttempts) {
                showStatus(2, 'error', 'âŒ éªŒè¯å¤±è´¥æ¬¡æ•°è¿‡å¤š');
                setTimeout(() => tg.close(), 2000);
                return;
            }
            
            showStatus(2, 'error', 'âŒ ' + reason);
            setTimeout(resetSlider, 800);
        }
        
        function resetSlider() {
            const thumb = document.getElementById('sliderThumb');
            thumb.style.left = '2px';
            thumb.innerHTML = 'â¬Œ';
            thumb.classList.remove('error', 'success');
            document.getElementById('pieceCanvas').style.left = '10px';
            document.getElementById('sliderProgress').style.width = '0px';
            document.getElementById('status2').className = 'status';
        }
        
        function updateAttemptInfo() {
            const remaining = maxAttempts - puzzleAttempts;
            document.getElementById('attemptInfo').textContent = 
                puzzleAttempts > 0 ? `å‰©ä½™å°è¯•: ${remaining} æ¬¡` : '';
        }
        
        function completeVerification() {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.querySelector('.step-indicator').style.display = 'none';
            document.querySelector('.footer').style.display = 'none';
            document.getElementById('successPage').classList.add('show');
            
            tg.sendData(JSON.stringify({
                verified: true,
                user_id: userId,
                token: turnstileToken,
                attempts: puzzleAttempts,
                trajectory_len: trajectory.length
            }));
            
            setTimeout(() => tg.close(), 1500);
        }
        
        // å³ä½¿æ²¡æœ‰ userId ä¹Ÿå…è®¸éªŒè¯ï¼ŒBot å¯ä»¥é€šè¿‡ message.from_user è·å–ç”¨æˆ·ä¿¡æ¯
        if (!userId) {
            console.log('Warning: userId not available, but continuing verification');
        }
        
        // ç«‹å³åˆå§‹åŒ–æ‹¼å›¾ï¼ˆè·³è¿‡ Turnstileï¼Œç›´æ¥è¿›å…¥æ‹¼å›¾ï¼‰
        goToStep(2);
        initPuzzle();
    </script>
</body>
</html>
